<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Whisper WebUI (MLX)</title>
    <style>
      :root {
        --ink: #1d1b16;
        --ink-muted: #5d5d5d;
        --panel: #fff7ee;
        --accent: #d46a3e;
        --accent-strong: #8b3f1f;
        --shadow: 0 24px 60px rgba(29, 27, 22, 0.12);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Avenir Next", Avenir, "Gill Sans", sans-serif;
        color: var(--ink);
        background: radial-gradient(circle at top left, #f6e6d4, transparent 55%),
          radial-gradient(circle at bottom right, #cfe1f2, transparent 45%),
          #f5f1ea;
      }

      main {
        max-width: 980px;
        margin: 0 auto;
        padding: 48px 24px 64px;
      }

      .hero {
        display: flex;
        flex-wrap: wrap;
        gap: 24px;
        align-items: center;
        justify-content: space-between;
      }

      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.18em;
        font-size: 0.72rem;
        color: var(--accent-strong);
      }

      h1 {
        margin: 8px 0 10px;
        font-size: clamp(2rem, 3vw, 3rem);
      }

      p {
        margin: 0;
        color: var(--ink-muted);
        line-height: 1.5;
      }

      .status-card {
        background: var(--panel);
        border: 1px solid #f1e2d2;
        border-radius: 16px;
        padding: 16px 20px;
        min-width: 180px;
        box-shadow: var(--shadow);
      }

      .status-label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.14em;
        color: var(--accent-strong);
      }

      .status {
        font-size: 1.4rem;
        font-weight: 700;
        margin: 6px 0;
      }

      .tabs {
        margin-top: 32px;
      }

      .tablist {
        display: flex;
        gap: 12px;
        padding: 8px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.7);
        box-shadow: 0 12px 30px rgba(29, 27, 22, 0.08);
      }

      .tab {
        appearance: none;
        border: none;
        background: transparent;
        padding: 10px 18px;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        color: var(--ink);
        cursor: pointer;
        text-decoration: none;
      }

      .tab.is-active {
        background: var(--accent);
        color: #fff;
        box-shadow: 0 12px 24px rgba(212, 106, 62, 0.35);
      }

      .tab:focus-visible {
        outline: 2px solid var(--accent-strong);
        outline-offset: 2px;
      }

      .panels {
        margin-top: 16px;
      }

      .panel {
        display: none;
        background: var(--panel);
        border: 1px solid #f1e2d2;
        border-radius: 18px;
        padding: 24px;
        box-shadow: var(--shadow);
      }

      .panel.is-active {
        display: block;
      }

      .upload-card {
        margin-top: 18px;
        padding: 16px;
        border-radius: 14px;
        background: #fff;
        border: 1px solid #f4e6d8;
        display: grid;
        gap: 12px;
      }

      .upload-label {
        font-weight: 600;
      }

      .upload-input {
        display: block;
        width: 100%;
      }

      .upload-select {
        display: block;
        width: 100%;
      }

      .upload-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
      }

      .cta {
        appearance: none;
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        background: var(--accent);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
      }

      .cta:hover {
        background: var(--accent-strong);
      }

      .hint {
        font-size: 0.85rem;
        color: var(--ink-muted);
      }

      .job-list {
        margin-top: 16px;
        display: grid;
        gap: 10px;
      }

      .job-row {
        display: flex;
        justify-content: space-between;
        gap: 16px;
        padding: 12px 14px;
        border-radius: 12px;
        background: #fff;
        border: 1px solid #f4e6d8;
      }

      .job-name {
        font-weight: 600;
      }

      .job-meta {
        font-size: 0.85rem;
        color: var(--ink-muted);
      }

      .job-status {
        text-transform: uppercase;
        letter-spacing: 0.1em;
        font-size: 0.72rem;
        color: var(--accent-strong);
        align-self: center;
      }

      .job-error {
        margin-top: 8px;
        padding: 8px 10px;
        background: #fff1f1;
        border: 1px solid #f4d2d2;
        border-radius: 8px;
        font-size: 0.82rem;
        color: #8b2f2f;
        white-space: pre-wrap;
      }

      .results {
        margin-top: 10px;
      }

      .result-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--accent-strong);
      }

      .result-list {
        list-style: none;
        margin: 6px 0 0;
        padding: 0;
        display: grid;
        gap: 6px;
      }

      .result-item {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .result-link {
        color: var(--accent-strong);
        text-decoration: none;
        font-weight: 600;
      }

      .result-link:hover {
        text-decoration: underline;
      }

      .result-link.is-text {
        color: var(--accent);
      }

      .result-action {
        font-size: 0.78rem;
        color: var(--ink-muted);
        text-decoration: none;
        border: 1px solid #f1e2d2;
        padding: 2px 8px;
        border-radius: 999px;
      }

      .result-action:hover {
        color: var(--accent-strong);
        border-color: var(--accent);
      }

      .result-empty {
        margin-top: 6px;
        font-size: 0.85rem;
        color: var(--ink-muted);
      }

      .placeholder {
        margin-top: 16px;
        padding-top: 16px;
        border-top: 1px dashed #e3d2c1;
        display: grid;
        gap: 10px;
      }

      .placeholder-row {
        padding: 12px 14px;
        border-radius: 10px;
        background: #fff;
        border: 1px solid #f4e6d8;
        color: var(--ink-muted);
      }

      @media (max-width: 720px) {
        main {
          padding: 32px 18px 48px;
        }

        .hero {
          flex-direction: column;
          align-items: flex-start;
        }

        .tablist {
          flex-direction: column;
          align-items: stretch;
        }

        .upload-actions {
          flex-direction: column;
          align-items: stretch;
        }

        .job-row {
          flex-direction: column;
          align-items: flex-start;
        }

        .status-card {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header class="hero">
        <div>
          <div class="eyebrow">Local-only transcription</div>
          <h1>Whisper WebUI (MLX)</h1>
          <p>Queue files for offline transcription. Upload and worker controls land here.</p>
        </div>
        <div class="status-card" aria-live="polite">
          <div class="status-label">Worker</div>
          <div class="status" id="worker-status">{{ worker.status }}</div>
          <p id="worker-detail">
            {% if worker.status == "Running" and worker.filename %}
              Running {{ worker.filename }}
            {% else %}
              Sequential queue, one job at a time.
            {% endif %}
          </p>
        </div>
      </header>

      <section class="tabs" aria-label="Main sections">
        <div class="tablist" role="tablist">
          <button
            class="tab is-active"
            role="tab"
            aria-selected="true"
            aria-controls="panel-queue"
            id="tab-queue"
            data-tab="queue"
          >
            Queue
          </button>
          <button
            class="tab"
            role="tab"
            aria-selected="false"
            aria-controls="panel-history"
            id="tab-history"
            data-tab="history"
          >
            History
          </button>
          <a class="tab" href="/live">Live</a>
        </div>

        <div class="panels">
          <section
            class="panel is-active"
            role="tabpanel"
            id="panel-queue"
            aria-labelledby="tab-queue"
            data-panel="queue"
          >
            <h2>Queue</h2>
            <p>Upload files to start a sequential transcription run.</p>
            <form class="upload-card" action="/upload" method="post" enctype="multipart/form-data">
              <label class="upload-label" for="file-input">Select audio or video files</label>
              <input
                id="file-input"
                class="upload-input"
                type="file"
                name="files"
                multiple
                required
                accept="audio/*,video/*"
              >
              <label class="upload-label" for="language-input">Language code (manual)</label>
              <input
                id="language-input"
                class="upload-select"
                name="language"
                list="language-options"
                placeholder="e.g. en, es, fr, pt-BR"
                required
                pattern="[a-z]{2,3}(-[A-Za-z]{2,3})?"
                title="Use a short language code like en or pt-BR"
              >
              <datalist id="language-options">
                <option value="en"></option>
                <option value="es"></option>
                <option value="fr"></option>
                <option value="de"></option>
                <option value="it"></option>
                <option value="pt-BR"></option>
                <option value="ja"></option>
                <option value="ko"></option>
                <option value="zh"></option>
              </datalist>
              <div class="upload-actions">
                <button class="cta" type="submit">Queue uploads</button>
                <span class="hint">Files stay local in data/uploads.</span>
              </div>
            </form>
            <div class="job-list" aria-live="polite" id="queue-list">
              {% for job in queue_jobs %}
                <div class="job-row">
                  <div>
                    <div class="job-name">{{ job.filename }}</div>
                    <div class="job-meta">Added {{ job.created_at }}</div>
                    <div class="job-meta">Language {{ job.language }}</div>
                    {% if job.started_at %}
                      <div class="job-meta">Started {{ job.started_at }}</div>
                    {% endif %}
                  </div>
                  <div class="job-status">{{ job.status }}</div>
                </div>
              {% endfor %}
            </div>
            <div class="placeholder" id="queue-placeholder"{% if queue_jobs %} style="display: none;"{% endif %}>
              <div class="placeholder-row">No jobs queued yet.</div>
              <div class="placeholder-row">Waiting for uploads.</div>
            </div>
          </section>

          <section
            class="panel"
            role="tabpanel"
            id="panel-history"
            aria-labelledby="tab-history"
            data-panel="history"
          >
            <h2>History</h2>
            <p>Completed jobs will appear here with download links.</p>
            <div class="job-list" aria-live="polite" id="history-list">
              {% for job in history_jobs %}
                <div class="job-row">
                  <div>
                    <div class="job-name">{{ job.filename }}</div>
                    <div class="job-meta">Added {{ job.created_at }}</div>
                    <div class="job-meta">Language {{ job.language }}</div>
                    {% if job.started_at %}
                      <div class="job-meta">Started {{ job.started_at }}</div>
                    {% endif %}
                    {% if job.completed_at %}
                      <div class="job-meta">Completed {{ job.completed_at }}</div>
                    {% endif %}
                    {% if job.status == "failed" and job.error_message %}
                      <div class="job-error">{{ job.error_message }}</div>
                    {% endif %}
                    <div class="results">
                      <div class="result-label">Results</div>
                      {% set results = results_by_job.get(job.id, []) %}
                      {% if results %}
                        <ul class="result-list">
                          {% for result in results %}
                            <li class="result-item">
                              <a
                                class="result-link{% if result.endswith('.txt') %} is-text{% endif %}"
                                href="/results/{{ job.id }}/{{ result }}"
                                target="_blank"
                                rel="noopener"
                              >
                                {{ result }}
                              </a>
                              <a
                                class="result-action"
                                href="/results/{{ job.id }}/{{ result }}"
                                download="{{ result }}"
                              >
                                Download
                              </a>
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <div class="result-empty">No results yet.</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="job-status">{{ job.status }}</div>
                </div>
              {% endfor %}
            </div>
            <div class="placeholder" id="history-placeholder"{% if history_jobs %} style="display: none;"{% endif %}>
              <div class="placeholder-row">No completed jobs yet.</div>
              <div class="placeholder-row">Check back after a run.</div>
            </div>
          </section>
        </div>
      </section>
    </main>

    <script>
      (function () {
        const tabs = document.querySelectorAll("[data-tab]");
        const panels = document.querySelectorAll("[data-panel]");
        if (!tabs.length) {
          return;
        }

        function activate(tabName) {
          tabs.forEach((tab) => {
            const isActive = tab.dataset.tab === tabName;
            tab.classList.toggle("is-active", isActive);
            tab.setAttribute("aria-selected", isActive ? "true" : "false");
          });

          panels.forEach((panel) => {
            panel.classList.toggle("is-active", panel.dataset.panel === tabName);
          });
        }

        const initialTab = new URLSearchParams(window.location.search).get("tab");
        if (initialTab && document.querySelector(`[data-tab="${initialTab}"]`)) {
          activate(initialTab);
        }

        tabs.forEach((tab) => {
          tab.addEventListener("click", () => activate(tab.dataset.tab));
        });

        const queueList = document.getElementById("queue-list");
        const historyList = document.getElementById("history-list");
        const queuePlaceholder = document.getElementById("queue-placeholder");
        const historyPlaceholder = document.getElementById("history-placeholder");
        const workerStatus = document.getElementById("worker-status");
        const workerDetail = document.getElementById("worker-detail");

        function escapeHtml(value) {
          return String(value)
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;")
            .replaceAll('"', "&quot;")
            .replaceAll("'", "&#39;");
        }

        function buildResults(jobId, results) {
          if (!results || results.length === 0) {
            return '<div class="result-empty">No results yet.</div>';
          }
          const encodedJobId = encodeURIComponent(jobId);
          const items = results
            .map((result) => {
              const encodedResult = encodeURIComponent(result);
              const safeResult = escapeHtml(result);
              const isText = result.endsWith(".txt");
              const textClass = isText ? " is-text" : "";
              return `
                <li class="result-item">
                  <a
                    class="result-link${textClass}"
                    href="/results/${encodedJobId}/${encodedResult}"
                    target="_blank"
                    rel="noopener"
                  >
                    ${safeResult}
                  </a>
                  <a
                    class="result-action"
                    href="/results/${encodedJobId}/${encodedResult}"
                    download="${safeResult}"
                  >
                    Download
                  </a>
                </li>
              `;
            })
            .join("");
          return `<ul class="result-list">${items}</ul>`;
        }

        function buildMetaLines(job) {
          const lines = [`Added ${escapeHtml(job.created_at)}`];
          if (job.language) {
            lines.push(`Language ${escapeHtml(job.language)}`);
          }
          if (job.started_at) {
            lines.push(`Started ${escapeHtml(job.started_at)}`);
          }
          if (job.completed_at) {
            lines.push(`Completed ${escapeHtml(job.completed_at)}`);
          }
          return lines
            .map((line) => `<div class="job-meta">${line}</div>`)
            .join("");
        }

        function renderJobs(listEl, placeholderEl, jobs, resultsByJob, isHistory) {
          if (!listEl || !placeholderEl) {
            return;
          }
          if (!jobs || jobs.length === 0) {
            listEl.innerHTML = "";
            placeholderEl.style.display = "grid";
            return;
          }
          placeholderEl.style.display = "none";
          listEl.innerHTML = jobs
            .map((job) => {
              const metaLines = buildMetaLines(job);
              const errorBlock =
                isHistory && job.status === "failed" && job.error_message
                  ? `<div class="job-error">${escapeHtml(job.error_message)}</div>`
                  : "";
              const results =
                isHistory
                  ? `
                    <div class="results">
                      <div class="result-label">Results</div>
                      ${buildResults(job.id, resultsByJob[job.id] || [])}
                    </div>
                  `
                  : "";
              return `
                <div class="job-row">
                  <div>
                    <div class="job-name">${escapeHtml(job.filename)}</div>
                    ${metaLines}
                    ${errorBlock}
                    ${results}
                  </div>
                  <div class="job-status">${escapeHtml(job.status)}</div>
                </div>
              `;
            })
            .join("");
        }

        async function refreshState() {
          try {
            const response = await fetch("/api/state", { cache: "no-store" });
            if (!response.ok) {
              return;
            }
            const payload = await response.json();
            const resultsByJob = payload.results_by_job || {};
            renderJobs(queueList, queuePlaceholder, payload.queue || [], resultsByJob, false);
            renderJobs(
              historyList,
              historyPlaceholder,
              payload.history || [],
              resultsByJob,
              true
            );
            if (payload.worker && workerStatus && workerDetail) {
              workerStatus.textContent = payload.worker.status || "Idle";
              if (payload.worker.status === "Running" && payload.worker.filename) {
                workerDetail.textContent = `Running ${payload.worker.filename}`;
              } else {
                workerDetail.textContent = "Sequential queue, one job at a time.";
              }
            }
          } catch (error) {
            console.warn("Failed to refresh state", error);
          }
        }

        setInterval(refreshState, 2500);
        refreshState();
      })();
    </script>
  </body>
</html>
